name: whale-app
region: nyc
features:
  - buildpack-stack=ubuntu-22

#######################################
#  GLOBAL ROUTES  (order matters!)
#######################################
routes:
  - path: /v1
    preserve_path: true
    component:
      name: ontario-taxapp-v2          # python API
  - path: /api
    preserve_path: true
    component:
      name: ontario-taxapp-v2
  - path: /
    preserve_path: true
    component:
      name: ontario-taxapp-v2-frontend # react static site

#######################################
#  PYTHON BACK-END
#######################################
services:
  - name: ontario-taxapp-v2
    environment_slug: python
    source_dir: /
    http_port: 8080
    instance_count: 1
    instance_size_slug: apps-s-1vcpu-1gb
    build_command: |
      pip install -r requirements.txt
    run_command: >
      gunicorn --worker-tmp-dir /dev/shm
      --config gunicorn.conf.py
      main:app --bind 0.0.0.0:8080
    envs:
      - key: DATABASE_URL
        scope: RUN_AND_BUILD_TIME
        value: postgresql://user:password@localhost:5432/retirement_sessions_db
      - key: TAX_YEARS_FILE
        scope: RUN_AND_BUILD_TIME
        value: backend/data/tax_years.yml
      - key: SESSION_DATA_TTL_HOURS
        scope: RUN_AND_BUILD_TIME
        value: "24"
      - key: OPENAI_API_KEY
        scope: RUN_AND_BUILD_TIME
        value: ${OPENAI_API_KEY}
      - key: RESEND_API_KEY
        scope: RUN_AND_BUILD_TIME
        value: re_XFws7iY9_EDwGBknV4Vnugutfb6do3mCN
      - key: FROM_EMAIL
        scope: RUN_AND_BUILD_TIME
        value: oascalculator@ontariotaxapp.com
      - key: FROM_NAME
        scope: RUN_AND_BUILD_TIME
        value: Ontario Tax App - OAS Calculator

#######################################
#  REACT STATIC FRONT-END
#######################################
static_sites:
  - name: ontario-taxapp-v2-frontend
    source_dir: frontend
    build_command: |
      npm ci && npm run build
    output_dir: build
    catchall_document: index.html
